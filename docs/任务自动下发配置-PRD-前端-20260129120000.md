# 任务自动下发配置 - 前端PRD文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 产品名称 | 任务自动下发配置 |
| 版本 | V1.3 |
| 创建日期 | 2026-01-28 |
| 更新日期 | 2026-01-29 |
| 所属模块 | 资产安全管理平台 - 系统维护 |
| 文档类型 | 前端PRD |

---

## 1. 需求背景

### 1.1 业务场景
安全运营团队需要定期对业务系统资产进行安全扫描检测（基线检测、弱口令检测、系统漏洞扫描、外部漏洞扫描），以满足集团安保考核要求：
- 每月/每两月需完成全量资产覆盖扫描
- 扫描结果用于集团数据上报
- 需避开业务高峰期（盲时）进行扫描

### 1.2 现状问题
- 手动创建扫描任务工作量大，容易遗漏
- 缺乏统一的调度管理机制
- 无法自动规避业务盲时
- 扫描失败或遗漏的资产需要人工排查补扫

### 1.3 目标
提供自动化的任务下发配置功能，实现：
- 按配置周期自动创建扫描任务
- 智能规避盲时下发
- 支持手动触发补充扫描
- 与AMR任务管理平台对接

---

## 2. 功能范围

本需求涵盖四种扫描类型的自动下发配置：
1. **基线检测** - 检测系统配置是否符合安全基线
2. **弱口令检测** - 检测系统账户是否存在弱口令
3. **系统漏洞扫描** - 检测系统内部漏洞
4. **外部漏洞扫描** - 检测对外暴露的漏洞

四种类型配置结构基本一致，差异点在"自动下发模式"部分（工具选择、模板选择）。

---

## 3. 页面结构设计

### 3.1 页面入口
- 路径：系统维护 → 任务自动下发配置
- 页面顶部Tab切换：基线检测 | 弱口令检测 | 系统漏洞 | 外部漏洞

### 3.2 页面布局
页面分为以下功能区块：
1. 自动下发参数
2. 自动下发时间（业务系统忙时）
3. 自动下发资产范围
4. 自动下发模式
5. 扫描记录（轮次管理）

---

## 4. 自动下发参数

### 4.1 配置项UI设计

| 配置项 | 组件类型 | 取值范围 | 必填 | 说明 |
|--------|----------|----------|------|------|
| 是否开启 | Switch开关 | 开/关 | 是 | 控制自动调度是否生效 |
| 每月开始扫描日期 | Select下拉选择 | 1-31 | 是 | 每月几号开始自动创建任务，以最后一天为准（如选31号，2月则为28/29号） |
| 开始时间 | Select下拉选择 | 0-23 | 是 | 每次开始扫描时间，按整小时选择（0-23点） |
| 单个任务下发最大资产数 | InputNumber数字输入 | 1-500 | 是 | 超过此数量则拆分为多个任务 |
| 任务超时最大等待时间 | InputNumber数字输入 | 1-10 | 是 | 单位：小时。等待上一轮任务完成的最大时长，最大不超过10小时 |
| 自动任务创建用户 | Select下拉选择 | 系统用户列表 | 是 | 自动创建的任务归属用户，需调用接口获取用户列表 |

### 4.2 前端校验规则

| 字段 | 校验规则 | 错误提示 |
|------|----------|----------|
| 每月开始扫描日期 | 必填，1-31范围 | 请选择每月开始扫描日期 |
| 开始时间 | 必填，0-23整点小时，不能在盲时范围内 | 开始时间不能配置在盲时范围内 |
| 单个任务下发最大资产数 | 必填，1-500范围 | 请输入1-500之间的数字 |
| 任务超时最大等待时间 | 必填，1-10范围 | 请输入1-10之间的数字 |
| 自动任务创建用户 | 必填 | 请选择自动任务创建用户 |

### 4.3 轮次状态展示

| 状态 | 展示文本 | 颜色/样式 | 列表展示 |
|------|----------|-----------|----------|
| pending | 待执行 | 灰色 | ✅ 展示 |
| waiting | 等待中 | 蓝色 | ✅ 展示 |
| running | 执行中 | 蓝色 | ✅ 展示 |
| success | 成功 | 绿色 | ✅ 展示 |
| failed | 失败 | 红色 | ✅ 展示 |
| partial_failed | 部分失败 | 橙色 | ✅ 展示 |
| skipped | 已跳过 | 灰色 | ✅ 展示 |
| cancelled | - | - | ❌ 不展示 |

---

## 5. 自动下发时间（业务系统忙时）

### 5.1 功能说明
配置不允许下发扫描任务的时间段，避开业务高峰期或特殊时期。

### 5.2 盲时类型UI设计

| 类型 | 组件类型 | 配置方式 | 示例 |
|------|----------|----------|------|
| 整月 | MonthPicker月份选择 | 选择月份 | 11月整月不扫描 |
| 指定日期 | DatePicker日期选择 | 选择月-日 | 10-01、10-02（10月1日、2日不扫描） |
| 时间段 | TimeRangePicker时间范围选择 | 选择时-分 ~ 时-分 | 06:00-18:00（每天该时段不扫描） |

**注意**：时间段盲时不支持跨天配置（如 22:00-06:00），开始时间必须小于结束时间。

### 5.3 配置项UI设计

| 配置项 | 组件类型 | 说明 |
|--------|----------|------|
| 盲时列表 | Table表格 + 动态增删行 | 支持添加多条盲时规则 |
| 下发任务距离忙时间隔 | InputNumber数字输入 | 单位：小时。距离忙时开始前X小时内不下发任务 |

### 5.4 前端校验规则

| 校验项 | 校验规则 | 错误提示 |
|--------|----------|----------|
| 时间段盲时 | 开始时间必须小于结束时间 | 开始时间必须小于结束时间，不支持跨天配置 |
| 盲时配置保存 | 调用后端接口校验是否导致全年无可执行时间 | 盲时配置过多，无法找到可执行时间，请调整配置 |

### 5.5 盲时规则说明
- **判断优先级**：盲时判断顺序为 整月 → 指定日期 → 时间段
- **盲时仅控制下发时机**：盲时不控制任务执行时长，若任务执行跨越盲时，不会中断已执行的任务
- 前端帮助文案或提示需体现上述规则，避免用户误解

---

## 6. 自动下发资产范围

### 6.1 配置项UI设计

| 配置项 | 组件类型 | 选项 | 说明 |
|--------|----------|------|------|
| 选择资产范围 | Radio单选 | 全部资产 / 仅上报资产 / 非上报资产 | 基于资产的"是否上报"属性筛选 |
| 选择业务系统范围 | TreeSelect树形多选下拉 | 业务系统列表 | 支持按名称模糊搜索，按资产组显示顺序排序 |

### 6.2 业务系统选择交互规则

| 规则 | 说明 |
|------|------|
| 层级展示 | 保留父子节点的层级关系展示 |
| 勾选联动 | 不联动（勾选父节点不自动勾选子节点，勾选哪个就是哪个） |
| 搜索功能 | 支持按名称模糊搜索 |
| 排序规则 | 按资产组管理中的"显示顺序"字段排序 |

### 6.3 外部漏洞扫描特殊规则
- **外部漏洞扫描**仅查询"应用"类型的资产（根据资产类型编码过滤）
- 若业务系统下无"应用"类型资产，则跳过该业务系统，不创建任务
- 前端可在外部漏洞Tab下增加提示文案："外部漏洞扫描仅针对应用类型资产"

---

## 7. 自动下发模式

### 7.1 通用配置UI设计

| 配置项 | 组件类型 | 说明 |
|--------|----------|------|
| 选择工具 | Card卡片单选 | 展示可用的扫描工具及版本 |
| 合规模板 | Select下拉选择（支持关键字模糊查询） | 选择扫描使用的模板，模板与工具、专题有对应关系。切换工具时模板列表会变化。**若工具无可选模板，则不需要选择，使用工具内置默认模板** |

### 7.2 差异配置

| 扫描类型 | 特殊配置 |
|----------|----------|
| 基线检测 | 需要选择模板，需要"保存原始结果"Checkbox（默认勾选） |
| 弱口令检测 | 需要选择模板，需要"保存原始结果"Checkbox（默认勾选） |
| 系统漏洞 | 需要选择模板，无原始结果选项 |
| 外部漏洞 | 需要选择模板，无原始结果选项 |

### 7.3 工具切换交互
- 切换工具时，模板列表需要重新加载
- 若当前选中的模板不在新工具的模板列表中，需清空模板选择
- **若工具无可选模板列表，模板下拉框显示为禁用状态，并显示提示文案"该工具使用内置默认模板"，保存时不校验模板必选**

---

## 8. 扫描记录（轮次管理）

### 8.1 功能说明
展示自动下发的执行记录，支持查看历史扫描情况和手动触发新一轮次。

### 8.2 页面元素

| 元素 | 组件类型 | 说明 |
|------|----------|------|
| 自动扫描情况跟踪 | Button按钮 | 弹出历史扫描记录弹框 |
| 下发新一轮次任务 | Button按钮 | 手动触发新一轮扫描 |

---

### 8.3 自动扫描情况跟踪弹框

点击"自动扫描情况跟踪"按钮，弹出历史扫描记录弹框。

#### 8.3.1 功能定位
记录每次调度的结果，包括成功执行和跳过的情况，用于查看历史扫描情况和失败分析。

#### 8.3.2 查询条件

| 字段 | 组件类型 | 说明 |
|------|----------|------|
| 月份 | MonthPicker月份选择器 | 按月份筛选 |
| 业务系统 | Select下拉选择 | 按业务系统筛选 |
| 状态 | Select下拉框 | 全部/待执行/等待中/执行中/成功/失败/部分失败/已跳过 |

#### 8.3.3 列表字段

| 字段 | 说明 | 展示方式 |
|------|------|----------|
| 序号 | 行号 | 1, 2, 3... |
| 月份 | 任务版本/月份 | 2026-01 |
| 执行轮次 | 轮次标识，格式：{月份}_{触发类型}_{序号} | 202601_自动_01、202601_手动_02 |
| 目标名称 | 本轮包含的业务系统 | "共10个业务系统"，鼠标悬停Tooltip显示详情列表 |
| 失败业务系统 | 任务创建失败的业务系统（非扫描执行失败） | "共2个"或"-"，鼠标悬停Tooltip显示详情列表 |
| 执行时间 | 本轮实际执行时间或计划时间 | 见下方说明 |
| 状态 | 本轮执行结果 | 待执行/等待中/执行中/成功/失败/部分失败/已跳过（带颜色Tag） |
| 操作 | 查看明细 | Link链接，点击弹出明细弹框 |

**执行时间展示规则**：
- pending 状态：显示"计划：{plan_start_time}"
- waiting 状态：显示"-"
- 其他状态：显示 actual_start_time

#### 8.3.4 状态Tag样式

| 状态 | 展示文本 | Tag颜色 |
|------|----------|---------|
| pending | 待执行 | 灰色(default) |
| waiting | 等待中 | 蓝色(processing) |
| running | 执行中 | 蓝色(processing) |
| success | 成功 | 绿色(success) |
| failed | 失败 | 红色(error) |
| partial_failed | 部分失败 | 橙色(warning) |
| skipped | 已跳过 | 灰色(default) |

#### 8.3.5 数据示例

| 序号 | 月份 | 执行轮次 | 目标名称 | 失败业务系统 | 执行时间 | 状态 | 操作 |
|------|------|----------|----------|--------------|----------|------|------|
| 1 | 2026-02 | 202602_自动_01 | 共10个业务系统 | - | 计划：2026-02-20 00:00 | 待执行 | - |
| 2 | 2026-01 | 202601_手动_02 | 共2个业务系统 | - | 2026-01-25 10:00 | 成功 | 查看明细 |
| 3 | 2026-01 | 202601_自动_01 | 共10个业务系统 | 共2个 | 2026-01-20 00:00 | 部分失败 | 查看明细 |
| 4 | 2025-12 | 202512_自动_01 | 共10个业务系统 | - | 2025-12-20 00:00 | 已跳过 | - |
| 5 | 2025-11 | 202511_自动_01 | 共10个业务系统 | - | 2025-11-20 00:00 | 成功 | 查看明细 |

**说明**：
- pending 状态的轮次展示计划执行时间，操作列无"查看明细"链接
- skipped 状态的轮次展示原计划扫描的业务系统数量，操作列无"查看明细"链接

---

### 8.4 轮次执行明细弹框

点击"查看明细"后，展示本轮每个业务系统的执行详情。

#### 8.4.1 明细列表字段

| 字段 | 说明 |
|------|------|
| 序号 | 行号 |
| 业务系统名称 | 业务系统名称 |
| 资产数 | 本任务包含的资产数量 |
| AMR任务ID | 关联的AMR任务ID（可点击Link跳转到AMR任务详情） |
| AMR任务名称 | AMR任务名称，包含轮次标识便于搜索 |

**说明**：任务状态、开始时间、结束时间、失败原因等信息通过AMR接口实时查询展示，不在本系统存储。

#### 8.4.2 明细数据示例

| 序号 | 业务系统名称 | 资产数 | AMR任务ID | AMR任务名称 |
|------|--------------|--------|-----------|-------------|
| 1 | 核心交易系统 | 50 | 10001 | 基线检测_202511_自动_01_核心交易系统 |
| 2 | 支付系统 | 30 | 10002 | 基线检测_202511_自动_01_支付系统 |
| 3 | 用户中心 | 20 | 10003 | 基线检测_202511_自动_01_用户中心 |

**AMR任务名称格式**：`{扫描类型}_{轮次标识}_{业务系统名称}`

---

### 8.5 手动下发新一轮次弹框

点击"下发新一轮次任务"按钮，弹出配置弹窗。

#### 8.5.1 弹框配置项

| 配置项 | 组件类型 | 说明 |
|--------|----------|------|
| 定时开始时间 | DateTimePicker日期时间选择 | 选择任务下发的时间点。可不选（立即执行）或选择具体时间 |
| 选择资产范围 | Checkbox复选框组 | 全部 / 上次扫描失败资产 / 本轮未扫描到的资产 |

#### 8.5.1.1 存在手动pending时的交互规则

**场景A：选择定时时间**
- 若已存在 pending 状态的手动调度，点击确认时：
  - 更新该记录的计划执行时间（plan_start_time）
  - 若新时间与原时间在同一月份 → 保持原有的 task_version/round_no/round_tag 不变
  - 若新时间跨月 → 重新计算 task_version/round_no/round_tag（按新的计划执行月份），并提示用户："执行时间已跨月，轮次编号将更新为{新月份}的轮次"
  - 可增加提示："已更新原定时任务的执行时间"

**场景B：不选时间（立即执行）**
- 若已存在 pending 状态的手动调度，点击确认时：
  - 弹出确认框提示："当前存在待执行的定时任务，立即执行将取消该定时任务并创建新任务，是否继续？"
  - 用户确认后：将原 pending 记录状态改为 cancelled，创建新记录立即执行（**新记录使用新的 round_no**）
- 若不存在 pending 状态的手动调度，直接创建新记录立即执行

#### 8.5.2 资产范围选择规则

| 选项 | 说明 |
|------|------|
| 全部 | 当前配置的所有业务系统下的所有资产（根据资产范围筛选条件） |
| 上次扫描失败资产 | 最近一次完成的轮次中，扫描结果为失败的资产（不区分自动/手动） |
| 本轮未扫描到的资产 | 当前配置的全部资产 - 最近一次完成的轮次中已扫描过的资产（不含专题任务） |

**"本轮"定义**：指最近一次完成的轮次（状态为 success/failed/partial_failed），不区分自动或手动触发，不限于本月。

#### 8.5.3 选择交互规则
- 选择"全部"时，其他两项置灰不可选
- "上次扫描失败资产"和"本轮未扫描到的资产"可同时勾选，取**并集**

#### 8.5.4 前端校验规则

| 校验项 | 校验时机 | 错误提示 |
|--------|----------|----------|
| 是否存在 waiting/running 状态的轮次 | 点击确认时（调用后端接口） | 当前存在执行中的调度，请等待完成后再操作 |
| 定时时间是否在盲时内 | 选择时间时（调用后端接口校验） | 所选时间在盲时范围内，请重新选择 |
| 定时时间是否在距盲时间隔内 | 选择时间时（调用后端接口校验） | 所选时间距离盲时不足X小时，请重新选择 |
| 当前时间是否在盲时内（立即执行） | 点击确认时（调用后端接口校验） | 当前处于盲时，请选择定时执行时间 |
| 当前时间是否在距盲时间隔内（立即执行） | 点击确认时（调用后端接口校验） | 当前距离盲时不足X小时，请选择定时执行时间 |

---

## 9. 接口需求

### 9.1 配置管理接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/auto-scan/config/{scanType} | GET | 获取指定扫描类型的配置 |
| /api/auto-scan/config/{scanType} | POST/PUT | 保存/更新配置 |
| /api/auto-scan/config/{scanType}/enable | PUT | 开启/关闭自动下发 |

### 9.2 数据查询接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/auto-scan/users | GET | 获取系统用户列表（用于下拉选择） |
| /api/auto-scan/systems | GET | 获取业务系统树形列表 |
| /api/auto-scan/tools/{scanType} | GET | 获取指定扫描类型的可用工具列表 |
| /api/auto-scan/templates | GET | 获取模板列表（根据工具ID筛选） |

### 9.3 轮次管理接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/auto-scan/rounds | GET | 获取轮次列表（支持分页、筛选） |
| /api/auto-scan/rounds/{roundId}/tasks | GET | 获取轮次任务明细 |
| /api/auto-scan/rounds/manual | POST | 手动触发新一轮次 |

### 9.4 校验接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/auto-scan/validate/blind-time | POST | 校验盲时配置是否有效 |
| /api/auto-scan/validate/schedule-time | POST | 校验定时时间是否在盲时内 |
| /api/auto-scan/validate/can-execute | GET | 校验当前是否可以立即执行 |

---

## 10. 交互细节

### 10.1 Tab切换
- 切换Tab时，加载对应扫描类型的配置数据
- 若有未保存的修改，提示用户是否保存

### 10.2 配置保存
- 点击保存按钮时，先进行前端校验
- 前端校验通过后，调用后端接口保存
- 后端返回盲时配置校验失败时，展示错误提示

### 10.3 开关切换
- 开启时：若配置不完整，提示先完善配置
- 关闭时：二次确认弹框，提示"关闭后将取消待执行的**自动**调度任务，已有的手动调度任务不受影响"

### 10.4 列表刷新
- 轮次列表支持手动刷新按钮
- 建议增加自动刷新机制（如30秒刷新一次），展示最新状态

---

## 11. 附录

### 11.1 术语说明

| 术语 | 说明 |
|------|------|
| AMR | 任务管理平台，负责任务的创建、调度、状态管理 |
| 盲时 | 不允许下发扫描任务的时间段 |
| 轮次 | 一次完整的调度执行周期 |
| 工具管理 | 扫描工具管理平台，负责实际执行扫描任务 |
| pending | 调度记录已创建，等待到达执行时间 |
| cancelled | 手动调度被新的立即执行取代 |

### 11.2 参考文档
- AMR任务管理平台接口文档
- 资产组管理功能说明
- 工具管理平台负载配置说明

### 11.3 版本历史

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| V1.0 | 2026-01-28 | 初稿 |
| V1.1 | 2026-01-29 | 补充调度机制、盲时规避等细节 |
| V1.2 | 2026-01-29 | 新增轮次状态（pending/running/cancelled），完善手动触发逻辑，明确配置变更处理规则 |
| V1.3 | 2026-01-29 | 移除skip_count字段；增加盲时配置保存校验；明确资产范围实时计算时机；增加服务重启对cancelled状态的恢复处理；补充业务系统无资产时跳过逻辑；增加数据库索引建议 |
