# Review Report

## 1) 摘要
文档结构完整、规则覆盖较全，但存在若干关键一致性与可执行性问题，主要集中在轮次号/月份规则、等待逻辑实现方式和调度创建规则的前后冲突。建议先统一这些规则，再进入实现设计。

## 2) 问题清单
- 高：手动 pending 跨月更新时间时“round_tag/round_no 不变”与“按计划执行月份计算轮次号”规则冲突，可能导致 round_tag 与 task_version/round_no 不匹配。证据：`docs/任务自动下发配置-PRD-20260129120000.md:715-716`、`docs/任务自动下发配置-PRD-20260129120000.md:1072`。
- 高：等待逻辑以阻塞 sleep 方式实现，与“动态调度避免轮询/零资源浪费”的原则冲突且存在线程耗尽风险（每个 waiting 可阻塞至 10 小时）。证据：`docs/任务自动下发配置-PRD-20260129120000.md:82-94`、`docs/任务自动下发配置-PRD-20260129120000.md:363-379`。
- 中：下一次自动调度创建逻辑前后不一致：流程图要求“存在 pending 则不创建”，但伪代码无条件 `createNextPendingRound()`，可能导致重复 pending 记录。证据：`docs/任务自动下发配置-PRD-20260129120000.md:212-216`、`docs/任务自动下发配置-PRD-20260129120000.md:386-388`。
- 中：“距盲时时间间隔”计算中“下一个盲时开始”的定义不清晰，存在月/日/时间段盲时叠加时的判定歧义。证据：`docs/任务自动下发配置-PRD-20260129120000.md:133-141`、`docs/任务自动下发配置-PRD-20260129120000.md:491-510`。
- 低：`save_raw_result` 字段在数据模型中未限定适用扫描类型（系统漏洞/外部漏洞是否允许或强制为 0 不明确），可能造成配置与实际 UI 逻辑不一致。证据：`docs/任务自动下发配置-PRD-20260129120000.md:565-575`、`docs/任务自动下发配置-PRD-20260129120000.md:841-845`。

## 3) 修改建议
- 对应问题1：明确手动 pending 重新定时跨月时的处理规则：A) 禁止跨月调整；或 B) 允许但需重新计算并更新 `task_version/round_no/round_tag`（含唯一性与展示规则）。
- 对应问题2：将“等待检查”改为非阻塞的定时重试（重新注册调度或独立检查任务），避免在调度线程中 `sleep`；并说明调度线程池容量与并发上限策略。
- 对应问题3：在伪代码与流程图中统一补充“已存在 pending 自动调度则不创建”的判断条件与触发时机。
- 对应问题4：补充“下一个盲时”的计算规则：以所有盲时规则计算出未来最近的实际开始时间，明确间隔判断是否对月/日/时间段全部适用。
- 对应问题5：在数据模型或校验规则中注明 `save_raw_result` 对不同扫描类型的取值范围与默认值（如非适用类型强制为 0）。

## 4) 风险/待确认点
- 是否允许手动定时跨月修改已存在 pending？若允许，需要明确数据模型及展示字段更新策略。
- “距盲时时间间隔”是否适用于整月/指定日期盲时？若适用，跨月/跨日的“下一次盲时”边界需明确。
