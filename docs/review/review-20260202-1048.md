# Review Report

## 摘要
本文档结构完整，覆盖调度机制、盲时、资产范围、数据模型与边界场景。主要问题集中在状态语义与字段定义的一致性、模板必填性与默认策略的冲突，以及“等待/重试”流程与展示字段的模糊定义，建议在实现前统一口径。

## 问题清单
1) **P0：状态流转语义冲突（pending vs waiting）**
- 生命周期说明里写明当存在 waiting/running 轮次时“拒绝调度，保持 pending”，并在10分钟后重试；但等待逻辑又定义为“若上一轮未完成则状态→waiting”。这会导致同一触发条件下到底是“保持 pending”还是“进入 waiting”不一致，影响计时、展示与恢复逻辑。 
- 证据：`docs/任务自动下发配置-PRD-20260129120000.md:198`、`docs/任务自动下发配置-PRD-20260129120000.md:470`。

2) **P0：template 必填性与“内置默认模板”冲突**
- 通用配置表将“合规模板”定义为必选；差异配置又说明“有的工具可能没有模板（使用内置默认模板）”。这会引发 UI 必填校验、数据模型 template_id 是否允许为空的实现冲突。 
- 证据：`docs/任务自动下发配置-PRD-20260129120000.md:554`、`docs/任务自动下发配置-PRD-20260129120000.md:571`、`docs/任务自动下发配置-PRD-20260129120000.md:839`。

3) **P1：waiting 状态计时字段未定义，影响恢复与超时计算**
- 服务重启恢复逻辑里等待状态使用 actual_start_time 计算剩余等待时间，但表结构将 actual_start_time 描述为“实际开始时间”，且列表展示规则中 waiting 状态显示“-”，未明确该字段在 waiting 阶段是否会写入。若不写入将导致恢复时无法正确计算剩余时间。 
- 证据：`docs/任务自动下发配置-PRD-20260129120000.md:241`、`docs/任务自动下发配置-PRD-20260129120000.md:625`、`docs/任务自动下发配置-PRD-20260129120000.md:905`。

4) **P2：列表“失败业务系统”口径与状态语义可能误导**
- 文档明确轮次状态是“任务创建结果”，非“任务执行结果”；但列表字段“失败业务系统”描述为“本轮扫描失败的业务系统”，容易被理解为扫描结果失败。应明确这里指“任务创建失败的业务系统”。 
- 证据：`docs/任务自动下发配置-PRD-20260129120000.md:618`、`docs/任务自动下发配置-PRD-20260129120000.md:641`。

## 修改建议
1) 统一“存在 waiting/running 时”的状态处理：明确是“保持 pending 并延迟触发”还是“进入 waiting 并开始计时”，并在流程图、等待逻辑与表字段含义中同步一致。对应修订 `docs/任务自动下发配置-PRD-20260129120000.md:198` 与 `docs/任务自动下发配置-PRD-20260129120000.md:470`。
2) 明确模板选择是否必填：
   - 若模板可缺省：在 7.1 中标注“可选”，并在数据模型说明 template_id 可为空或有默认值。 
   - 若必须选择：移除“工具可能没有模板”的描述或定义“内置默认模板”的具体选择规则。对应修订 `docs/任务自动下发配置-PRD-20260129120000.md:554`、`docs/任务自动下发配置-PRD-20260129120000.md:571`、`docs/任务自动下发配置-PRD-20260129120000.md:839`。
3) 定义 waiting 阶段的时间戳：新增 waiting_start_time 或明确 actual_start_time 在进入 waiting 时即写入，并在列表展示中说明。对应修订 `docs/任务自动下发配置-PRD-20260129120000.md:241`、`docs/任务自动下发配置-PRD-20260129120000.md:625`、`docs/任务自动下发配置-PRD-20260129120000.md:905`。
4) 将“失败业务系统”的含义表述为“任务创建失败”，避免与扫描执行结果混淆。对应修订 `docs/任务自动下发配置-PRD-20260129120000.md:618`、`docs/任务自动下发配置-PRD-20260129120000.md:641`。

## 风险/待确认点
- 若状态流转未统一，可能出现 UI 展示“待执行”但后台已在等待计时，或超时判断失准，导致跳过/重试策略不一致。
- 若模板是否必填未明确，前后端校验与数据库约束可能冲突，导致创建任务失败或配置保存失败。
- waiting 计时字段不清晰会影响服务重启后的恢复与超时判断，进而导致错误的 skipped/failed 结论。
