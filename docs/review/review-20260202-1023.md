# Review Report

## 摘要
该PRD结构完整、流程与数据模型覆盖较全面，但存在若干关键一致性与可落地性问题，主要集中在数据模型字段缺失、资产范围定义不一致，以及执行时配置取值策略的冲突。建议先澄清这些核心规则，再进入研发排期。

## 问题清单
1. **高**：数据模型缺少“失败原因”字段，无法满足多处“记录失败原因”的需求。文档多处要求在任务创建失败/无资产等场景记录失败原因，但`auto_scan_round`表仅有`skip_reason`和`cancel_reason`字段。文件：`docs/任务自动下发配置-PRD-20260129120000.md`（4.2.5、11.2、11.3、11.7 与 10.4）。
2. **高**：资产范围枚举值不一致，可能导致实现与UI/逻辑不匹配。数据表`auto_scan_config.asset_scope`取值为`all/reported/unreported`，而手动触发与逻辑中使用`all/failed/unscanned/failed_and_unscanned`及“上次扫描失败资产/本轮未扫描到的资产”。文件：`docs/任务自动下发配置-PRD-20260129120000.md`（8.5.2、10.1、10.4）。
3. **中**：“本轮”统计口径存在自相矛盾。先定义“本轮”为最近一次完成的轮次且不区分自动/手动，但随后又说明“只统计自动下发的任务”。文件：`docs/任务自动下发配置-PRD-20260129120000.md`（8.5.2）。
4. **中**：执行时配置取值策略不一致。配置变更说明指出业务系统范围在执行时实时查询，但轮次表`target_system_ids/target_system_count`在pending创建时固化，未说明执行时是否以“固化值”或“实时配置”为准，可能导致显示与执行不一致。文件：`docs/任务自动下发配置-PRD-20260129120000.md`（4.2.7、10.4）。
5. **中**：下次执行时间算法在“距盲时间隔检查”后未明确重新进行盲时校验，可能出现跳转后仍落在盲时内或又触发其他盲时的情况。文件：`docs/任务自动下发配置-PRD-20260129120000.md`（4.2.3）。
6. **低**：手动定时触发若选择跨月时间，`task_version/round_no`取值规则未明确（按计划执行月还是按创建月）。现有示例仅覆盖同月。文件：`docs/任务自动下发配置-PRD-20260129120000.md`（8.5.1、11.8、10.4）。
7. **低**：可靠性要求提到“调度任务异常延迟重试”，但AMR接口异常处理中明确“不自动重试”，两者范围边界不清。文件：`docs/任务自动下发配置-PRD-20260129120000.md`（11.7、12.2）。

## 修改建议
1. 在`auto_scan_round`补充`fail_reason`字段（或统一为`reason`+`reason_type`），并明确记录规则与展示口径。对应问题1。
2. 统一资产范围枚举及命名：若“reported/unreported”为历史字段，应明确映射关系；否则建议改为`all/failed/unscanned/failed_and_unscanned`并同步UI与逻辑。对应问题2。
3. 明确“本轮”统计口径：是否包含手动轮次、是否包含自动轮次、是否排除专题任务，三者需一致。对应问题3。
4. 明确执行时以“实时配置”还是“pending固化配置”为准：若实时执行，需说明`target_system_ids`仅用于展示；若固化执行，需调整配置变更说明。对应问题4。
5. 在下次执行时间算法中加入“距盲时间隔跳转后重新校验盲时”的闭环说明，并覆盖跨日/跨月场景。对应问题5。
6. 补充手动定时跨月的`task_version/round_no`规则，并举1个跨月示例。对应问题6。
7. 区分“调度异常重试”与“AMR创建任务失败不重试”的范围，明确何种异常会触发延迟重试。对应问题7。

## 风险/待确认点
- AMR接口失败不重试的选择是否符合业务SLA？是否需要与“手动补扫”机制形成明确闭环？文件：`docs/任务自动下发配置-PRD-20260129120000.md`（11.7）。
- 多实例并发控制使用Redis或数据库锁的选择、锁粒度与超时策略未定义，可能影响一致性与可用性。文件：`docs/任务自动下发配置-PRD-20260129120000.md`（11.4）。
