# 任务自动下发配置 - 会议确认项整理

> 基于 2025-01-29 会议录音整理（红军营南路3_transcript.txt）

---

## 确认项清单

### 1. 开始日期增加开始时间配置

**现状**：原来只配置了扫描日期（几号），没有配置具体时间点

**修改**：
- 增加"开始时间"配置项
- 默认显示零点（00:00）
- 用户可选择其他时间点

**校验要求**：
- 开始时间需要与盲时时间做校验
- 不能配置在盲时范围内

**原话依据**：
> "只是配置了盲时对吧，有一个只是配置盲时但是没说开始时间...那这块需要加一个吧...加一个时间默认让它显示零点，如果想选的话其他点就让它选，那这块就需要跟下一个盲时的时间去做一下校验"

---

### 2. 手动触发与自动调度时间的关系

**确认结论**：手动触发分两种情况

**情况一：立即执行（不选时间）**
- 不影响下次自动调度时间
- 立即执行需要检测当前是否在盲时
- 如果在盲时，需要提示用户选择时间

**情况二：选择时间执行**
- 选择的时间会**覆盖**下次自动调度时间
- 该手动任务执行完成后，系统会重新根据配置计算下一次自动调度时间

**原话依据**：
> "手动触发不会影响你那个下一次自动触发时间的"
> "如果你这选时间了，那我就把你这个时间作为我下一次的那个时间去做，然后它执行完了之后我再去按照那个配置再去生成"
> "都会取消，这个完了之后这个手动任务完成之后它会重新计算"

---

### 3. 失败调度推送公告

**确认结论**：以下情况需要推送到公告系统

- 轮次跳过（因上轮任务超时未完成）
- 连续多轮跳过
- 调度失败

**目的**：让用户及时知道系统存在问题，需要人工处理

**原话依据**：
> "推到公告里面行，我把这个记一下，到时候我再完事，行推到公告里面，反正就是大概是这些这几个信息吧，连续多轮跳过这种可以都可以做一下"

---

### 4. 调用AMR接口按业务系统显示顺序

**确认结论**：
- 创建任务时，按照业务系统的"显示顺序"字段确定调用AMR接口的次序
- 显示顺序从资产组管理中的业务系统配置获取

**原话依据**：
> "先创建哪个业务系统的任务啊，就这个执行排序...业务系统那个本身里面显示顺序对吧"

---

### 5. 业务系统勾选逻辑

**确认结论**：
- 勾选哪个业务系统就是哪个，**不递归查询子节点**
- 展示时保留父子节点的层级关系
- 勾选时不联动（勾选父节点不自动勾选子节点）
- 存储时平铺存储，不存储层级关系

**原话依据**：
> "你勾选一个就是一个，你要下面子的你就需要勾选子的"
> "展示是需要有的，然后勾选是不需要的"
> "相当于把这个系统平铺开了，就是没有那个父子节点的关系，但是你在展示的时候都有父子节点的关系"

---

### 6. 资产查询类型过滤

**确认结论**：
- 外部漏洞扫描需要按资产类型过滤，只查询"应用"类型的资产
- 其他专题（基线、弱口令、系统漏洞）不需要特殊过滤

**待补充**：
- 需要提供具体的资产类型编码
- 根据类型编码在SQL中添加过滤条件

**原话依据**：
> "外部的是只查应用的...你在查资产都是加个类型去过滤，比如说我查外部漏洞...把那个类型条件给加上去就行了"
> "你给我个探点，根据类型编码你去过滤就行了"

---

### 7. 业务系统树支持搜索

**确认结论**：
- 业务系统选择需要支持按名称模糊搜索
- 输入名称后，下面列出匹配的业务系统

**待确认**：
- 需要确认前端组件是否支持树形搜索
- 如果组件不支持，可能需要自定义实现

**原话依据**：
> "按名称模糊搜索...输入名称模糊搜索，就是在这输入一个然后下面是跟他一样的模糊的把这列出来"
> "那得看看组件，不行我到时候让他自己写一个，应该是可以"

---

### 8. 系统漏洞、外部漏洞的模板配置

**确认结论**：
- 系统漏洞和外部漏洞需要有模板选择
- 模板与工具有对应关系
- 模板与专题也有对应关系

**待确认**：
- 需要确定模板的查询方式
- 切换不同工具时，模板列表会变化
- 有的工具可能没有模板（使用内置默认模板）

**原话依据**：
> "系统漏洞和外部漏洞是有模板的...模板跟工具是有对应关系的，而且跟专题有对应关系"
> "有的工具好像没有模板...它自己内置了一个就用那一个"

---

### 9. 工具、模板对应关系

**确认结论**：
- 不同专题对应不同的工具
- 工具与模板有对应关系
- 选择工具后，模板列表会相应变化

**待补充**：
- 需要确认四个专题（基线、弱口令、系统漏洞、外部漏洞）各自对应的工具
- 需要确认工具与模板的对应关系查询接口

**原话依据**：
> "这一块是不是不同的专题这块的对应的工具也不一样...四个专题都有模板要选"

---

### 10. 扫描记录页面增加业务系统查询

**确认结论**：
- 查询条件增加"业务系统"字段
- 最终查询条件：月份、业务系统、状态

**原话依据**：
> "这块加一个吧，然后加一个那叫啥，业务系统...就直接敢业务系统...行，这加个业务系统查询，然后就是三个，月份、业务系统和状态"

---

### 11. 轮次标识设计

**确认结论**：
- 轮次需要有一个唯一标识（tag）
- 该标识需要带到AMR任务名称上
- 方便在AMR侧搜索查询同一批任务

**标识设计建议**：
- 格式：月份 + 手动/自动标识 + 轮次序号
- 示例：202501_自动_01（2025年1月自动第1轮）
- 示例：202501_手动_02（2025年1月手动第2轮）

**原话依据**：
> "轮次可能记一个时间戳或者是时间戳其实挺好的...后面可以还再加一个手动还是自动的那么一个标识，然后完了之后后面再加上你轮次你是这个月的第一次第二次第三次第四次"
> "这样的话你到那块的时候就好，它可以去那边我一查是哪个轮次，你搜索就查出来，这样的话我哪个轮次然后什么去那一搜我这一批的任务也都能一块查下来"

---

### 12. 手动执行时间选择的影响

**确认结论**：
- 手动执行时，如果选择了时间，该时间会作为下一次调度时间
- 原有的自动调度时间会被取消/覆盖
- 手动任务执行完成后，系统重新根据配置计算下一次自动调度时间

**边界情况处理**：
- 如果选择的时间在原自动调度时间之前：取消原调度，按手动时间执行
- 如果选择的时间在原自动调度时间之后：同样取消原调度，按手动时间执行
- 无论哪种情况，执行完成后都会重新计算下次自动调度时间

**原话依据**：
> "如果你这选时间了那我就把你这个时间作为我下一次的那个时间去做"
> "都会取消...这个完了之后这个手动任务完成之后它会重新计算"

---

### 13. 未扫描到的资产处理

**确认结论**：
- "本轮未扫描到的资产"可能包含新增的资产
- 需要根据当前配置的业务系统重新查询资产
- 与上一次任务关联的资产对比，找出新增的资产

**处理逻辑**：
1. 根据配置的业务系统ID查询当前资产列表
2. 查询上一次任务关联的资产列表
3. 对比找出不在上次任务中的资产（即新增资产）
4. 将新增资产纳入本次扫描范围

**原话依据**：
> "本月未扫描到的资产...有可能会新增资产...中间增加了一些资产那就会把他那个没有扫描的就是不在的我去"
> "按照他那个业务系统重新把资产查一下，然后再跟上一次任务关联的资产里面去对比，如果不在上面的就说明这次这几个资产是我新增的"

---

### 14. auto_scan_config 表补充字段

**确认结论**：
- 需要补充"选择资产范围"相关字段
- 用于存储手动触发时选择的资产范围（全部/上次失败/本轮未扫描）

**新增字段建议**：
| 字段名 | 类型 | 说明 |
|--------|------|------|
| manual_asset_scope | varchar | 手动触发资产范围：ALL/FAILED/UNSCANNED |
| manual_start_time | datetime | 手动触发的开始时间 |

**原话依据**：
> "auto_scan_config 补充选择资产范围的字段...把这个字段加上，这个你如果是立即去执行的话我还能根据你选择的，我去查，如果是选的时间了我就得存一下"

---

## 表结构确认

### 共5张表

1. **扫描配置主表（auto_scan_config）**
   - 存储整体配置信息
   - 新增：开始时间、手动资产范围、手动开始时间字段

2. **配置业务系统关联表**
   - 扫描配置ID + 业务系统ID + 执行顺序

3. **配置盲时表**
   - 扫描配置ID + 盲时类型 + 盲时值

4. **扫描轮次表**
   - 记录每次调度的轮次信息
   - 包含：轮次标识、触发方式（自动/手动）、状态、跳过原因等

5. **轮次明细表**
   - 轮次ID + 业务系统ID + 业务系统名称 + 资产数 + AMR任务ID + AMR任务名称
   - **简化**：不存储任务状态和时间（避免维护同步问题）

**原话依据**：
> "有五张表，有一个配置表，然后配置业务系统关联表，还有个配置的盲时表，然后这块有个轮次表，轮次表一个轮次明细表，就把任务的ID和名称存一下就行了"
> "那我那行我把这些都去掉，页面也都去掉...那差不多就这些字段了"

---

## 其他确认事项

### 原始结果保存
- 基线检测和弱口令检测需要"保存原始结果"勾选项
- 系统漏洞和外部漏洞不需要

### 轮次明细页面
- 可以从轮次列表跳转到明细页面
- 明细展示：业务系统、资产数、AMR任务名称
- 后续可考虑：从明细页面跳转到AMR任务列表（带条件）

### 开发周期
- 预计下周开发测试完成

---

## 待办事项

- [ ] 前端确认业务系统树搜索组件是否支持
- [ ] 后端提供资产类型编码（外部漏洞过滤用）
- [ ] 确认四个专题的工具和模板对应关系
- [ ] 素伟更新原型图
- [ ] 设计轮次标识的具体格式
