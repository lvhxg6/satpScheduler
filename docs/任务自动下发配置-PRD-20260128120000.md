# 任务自动下发配置 - 产品需求文档（PRD）

## 文档信息

| 项目 | 内容 |
|------|------|
| 产品名称 | 任务自动下发配置 |
| 版本 | V1.0 |
| 创建日期 | 2026-01-28 |
| 所属模块 | 资产安全管理平台 - 系统维护 |

---

## 1. 需求背景

### 1.1 业务场景
安全运营团队需要定期对业务系统资产进行安全扫描检测（基线检测、弱口令检测、系统漏洞扫描、外部漏洞扫描），以满足集团安保考核要求：
- 每月/每两月需完成全量资产覆盖扫描
- 扫描结果用于集团数据上报
- 需避开业务高峰期（盲时）进行扫描

### 1.2 现状问题
- 手动创建扫描任务工作量大，容易遗漏
- 缺乏统一的调度管理机制
- 无法自动规避业务盲时
- 扫描失败或遗漏的资产需要人工排查补扫

### 1.3 目标
提供自动化的任务下发配置功能，实现：
- 按配置周期自动创建扫描任务
- 智能规避盲时下发
- 支持手动触发补充扫描
- 与AMR任务管理平台对接

---

## 2. 功能范围

本需求涵盖四种扫描类型的自动下发配置：
1. **基线检测** - 检测系统配置是否符合安全基线
2. **弱口令检测** - 检测系统账户是否存在弱口令
3. **系统漏洞扫描** - 检测系统内部漏洞
4. **外部漏洞扫描** - 检测对外暴露的漏洞

四种类型配置结构基本一致，差异点在"自动下发模式"部分（工具选择、模板选择）。

---

## 3. 功能详细设计

### 3.1 页面入口
- 路径：系统维护 → 任务自动下发配置
- 页面顶部Tab切换：基线检测 | 弱口令检测 | 系统漏洞 | 外部漏洞

### 3.2 页面布局
页面分为以下功能区块：
1. 自动下发参数
2. 自动下发时间（盲时配置）
3. 自动下发资产范围
4. 自动下发模式
5. 扫描记录（轮次管理）

---

## 4. 自动下发参数

### 4.1 配置项说明

| 配置项 | 类型 | 取值范围 | 必填 | 说明 |
|--------|------|----------|------|------|
| 是否开启 | 开关 | 开/关 | 是 | 控制自动调度是否生效 |
| 每月开始扫描日期 | 下拉选择 | 1-31 | 是 | 每月几号开始自动创建任务，以最后一天为准（如选31号，2月则为28/29号） |
| 单个任务下发最大资产数 | 数字输入 | 1-500 | 是 | 超过此数量则拆分为多个任务 |
| 任务超时最大等待时间 | 数字输入 | 正整数 | 是 | 单位：小时。判断上一轮任务是否超时的阈值 |
| 自动任务创建用户 | 下拉选择 | 系统用户列表 | 是 | 自动创建的任务归属用户 |

### 4.2 业务规则

#### 4.2.1 调度机制设计

采用 **Spring TaskScheduler 动态调度**方案，按需触发，避免无效轮询。

**核心思路**：
- 不使用固定频率轮询，而是计算出"下次执行时间"，精确触发
- 配置保存时计算下次执行时间，注册定时任务
- 任务执行完成后，计算下一次执行时间，重新注册

**优势**：
- 零资源浪费（配置20号执行，1-19号无任何调度开销）
- 无需引入第三方依赖（Spring原生支持）
- 盲时提前计算，直接跳到可执行时间点

#### 4.2.2 下次执行时间计算逻辑

```
输入：每月扫描日期、盲时配置
输出：下次执行时间（精确到分钟）

计算步骤：
1. 确定基准日期
   - 若当前日期 < 本月扫描日期 → 基准日期 = 本月扫描日期
   - 若当前日期 >= 本月扫描日期 → 基准日期 = 下月扫描日期
   - 特殊处理：扫描日期为31号，当月不足31天则取当月最后一天

2. 盲时规避
   - 检查基准日期是否在"整月盲时"内 → 跳到下一个非盲时月份
   - 检查基准日期是否在"指定日期盲时"内 → 跳到下一天
   - 检查基准日期的00:00是否在"时间段盲时"内 → 跳到盲时结束时间
   
3. 距盲时间隔检查
   - 计算执行时间距离下一个盲时开始的间隔
   - 若间隔 < 配置的"距盲时时间间隔" → 跳到该盲时结束后

4. 输出最终的下次执行时间
```

#### 4.2.3 调度生命周期

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                              调度生命周期                                         │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────┐    ┌──────────────┐    ┌─────────────────────────────┐            │
│  │ 配置保存  │───▶│ 计算下次执行  │───▶│ 注册TaskScheduler定时任务    │            │
│  └──────────┘    │ 时间并持久化  │    └─────────────────────────────┘            │
│                  └──────────────┘                   │                            │
│                                                     ▼                            │
│                                         ┌─────────────────────────────┐          │
│                                         │ 到达执行时间，触发调度        │          │
│                                         └─────────────────────────────┘          │
│                                                     │                            │
│                                                     ▼                            │
│                                         ┌─────────────────────────────┐          │
│                                         │ 判断最近一轮是否有未完成任务  │          │
│                                         └─────────────────────────────┘          │
│                                            │         │         │                 │
│                         ┌──────────────────┘         │         └───────────┐     │
│                         ▼                            ▼                     ▼     │
│              ┌─────────────────┐      ┌─────────────────────┐   ┌──────────────┐│
│              │ 无未完成任务     │      │ 有未完成，未超过等待  │   │有未完成，已超 ││
│              │                 │      │ 时间                 │   │过等待时间    ││
│              └─────────────────┘      └─────────────────────┘   └──────────────┘│
│                         │                            │                     │     │
│                         ▼                            ▼                     ▼     │
│              ┌─────────────────┐      ┌─────────────────────┐   ┌──────────────┐│
│              │ 一次性创建所有   │      │ 延迟30分钟后         │   │ 本轮跳过      ││
│              │ 任务            │      │ 重新判断             │   │ 记录skipped  ││
│              │ skip_count清零  │      └─────────────────────┘   │ skip_count++ ││
│              └─────────────────┘                 │              └──────────────┘│
│                         │                        │                     │        │
│                         ▼                        │                     │        │
│              ┌─────────────────┐                 │                     │        │
│              │ 等待任务执行完成 │                 │                     │        │
│              │ 记录轮次结果     │◀────────────────┘                     │        │
│              └─────────────────┘                                       │        │
│                         │                                              │        │
│                         ▼                                              │        │
│              ┌─────────────────┐                                       │        │
│              │ 计算下月执行时间 │◀──────────────────────────────────────┘        │
│              └─────────────────┘                                                │
│                         │                                                       │
│                         ▼                                                       │
│              ┌─────────────────┐                                                │
│              │ 注册下次调度     │ ───────────────────────────────────────────────│
│              └─────────────────┘                                    (循环)      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

说明：
- 无论本轮是否创建任务，都会计算下月执行时间并注册下次调度
- 超时跳过后，下个月会重新判断，如果任务仍未完成则继续跳过
- 成功创建任务后 skip_count 清零，跳过时 skip_count++
- 需要人工处理卡住的任务后，下次调度才能正常创建
```

#### 4.2.4 页面告警提示设计

当出现以下异常情况时，页面需要显示明显的告警提示：

| 场景 | 提示位置 | 提示内容 | 提示样式 |
|------|----------|----------|----------|
| 存在未完成任务且已超时 | 配置页面顶部 | ⚠️ 上一轮次存在未完成任务已超过等待时间，本月自动调度已跳过。请处理卡住的任务后等待下月调度，或手动触发新轮次。 | 黄色警告条 |
| 连续多月跳过 | 配置页面顶部 | 🔴 自动调度已连续X个月跳过，请尽快处理未完成的任务！ | 红色警告条 |
| 存在未完成任务未超时 | 配置页面顶部 | ℹ️ 上一轮次存在未完成任务，等待中... | 蓝色提示条 |

#### 4.2.5 服务重启恢复

服务启动时自动恢复调度：
```
1. 查询所有已开启的扫描配置
2. 读取每个配置的 next_exec_time 字段
3. 若 next_exec_time > 当前时间 → 注册定时任务
4. 若 next_exec_time <= 当前时间 → 立即执行一次，然后计算下次时间
```

#### 4.2.6 配置变更处理

| 变更场景 | 处理方式 |
|----------|----------|
| 开启自动下发 | 计算下次执行时间，注册调度 |
| 关闭自动下发 | 取消已注册的调度任务 |
| 修改扫描日期 | 重新计算下次执行时间，更新调度 |
| 修改盲时配置 | 重新计算下次执行时间，更新调度 |

#### 4.2.7 轮次判断逻辑

任务触发时执行以下判断：
```
判断最近一轮是否存在未完成任务：
- 查询 auto_scan_round 最新一条非 skipped 状态的记录
- 再查询其下 auto_scan_round_task 是否有 status 不是 completed 且不是 failed 的任务
- 判断对象：最近一轮（无论是自动触发还是手动触发的轮次）
- 若无未完成任务 → 创建本轮任务
- 若有未完成任务：
  - 计算未完成时长（从轮次开始时间算起）
  - 未超过等待时间 → 延迟执行，重新计算下次时间（当前时间 + 30分钟）
  - 已超过等待时间 → 本轮跳过，创建一条 status=skipped 的轮次记录，skip_count++
```

**调度流程图**：
```
触发调度
    │
    ▼
判断最近一轮是否有未完成任务（查AMR任务状态）
    │
    ├─ 无未完成任务 → 创建本轮任务 → 等待执行完成 → 记录轮次（success/failed/partial_failed）
    │
    ├─ 有未完成，未超时 → 延迟30分钟后重新判断
    │
    └─ 有未完成，已超时 → 本轮跳过 → 记录轮次（skipped），skip_count++
    
    │
    ▼
计算下月执行时间，注册下次调度
```

**等待时间的含义**：容忍上轮未完成的最大时长。超过此时长说明任务可能卡住，系统不再自动创建新任务，避免任务堆积，需人工处理卡住的任务后再继续。

#### 4.2.8 任务拆分与创建逻辑

**拆分规则**：
- 按业务系统维度 + 最大资产数拆分
- 示例：选择了10个业务系统，每个业务系统10个资产，最大资产数配置为10
  - 则创建10个任务，每个任务包含1个业务系统的10个资产

**创建方式**：
- **一轮调度内，所有任务一次性全部创建**，不等待单个任务完成
- 调用AMR接口批量创建任务后，本轮调度即结束
- 任务创建完成后，立即计算下月执行时间，注册下次调度

**任务执行顺序**：
- 任务的实际执行顺序由工具管理平台控制（非本系统职责）
- 工具管理侧有负载控制机制，前一个任务完成后才下发下一个到扫描工具
- 本系统只负责创建任务，不负责控制执行顺序

#### 4.2.9 等待逻辑说明

**重要：等待判断只发生在"轮次与轮次之间"，不发生在"任务与任务之间"**

```
场景示例：
- 1月20日触发调度，创建10个任务 → 任务一次性全部创建 → 本轮结束
- 1月25日手动触发新轮次，创建5个任务 → 本轮结束
- 2月20日触发调度前，判断最近一轮（1月25日手动触发的轮次）的任务是否全部完成：
  - 全部完成 → 创建2月的任务
  - 有未完成且未超时 → 延迟30分钟后再判断
  - 有未完成且已超时 → 本月不创建，等3月再判断
```

**任务完不成的处理**：
- 单个任务卡住不会影响同轮次其他任务的创建（因为是一次性创建的）
- 单个任务卡住会影响下一轮次的创建（因为要判断上轮是否有未完成）
- 超过等待时间后，系统自动跳过本轮，用户需手动处理卡住的任务（终止或等待完成）

---

## 5. 自动下发时间（盲时配置）

### 5.1 功能说明
配置不允许下发扫描任务的时间段，避开业务高峰期或特殊时期。

### 5.2 盲时类型

| 类型 | 配置方式 | 示例 |
|------|----------|------|
| 整月 | 选择月份 | 11月整月不扫描 |
| 指定日期 | 选择月-日 | 10-01、10-02（10月1日、2日不扫描） |
| 时间段 | 选择时-分 ~ 时-分 | 06:00-18:00（每天该时段不扫描） |

### 5.3 配置项

| 配置项 | 类型 | 说明 |
|--------|------|------|
| 盲时列表 | 表格 | 支持添加多条盲时规则 |
| 下发任务距盲时时间间隔 | 数字输入 | 单位：小时。距离盲时开始前X小时内不下发任务 |

### 5.4 判断优先级
盲时判断顺序：整月 → 指定日期 → 时间段

### 5.5 业务规则
- 盲时仅控制任务下发时机，不控制任务执行时长
- 若任务执行跨越盲时，不会中断已执行的任务
- 盲时在计算"下次执行时间"时提前规避，而非触发时判断

---

## 6. 自动下发资产范围

### 6.1 配置项

| 配置项 | 类型 | 选项 | 说明 |
|--------|------|------|------|
| 选择资产范围 | 单选 | 全部资产 / 仅上报资产 / 非上报资产 | 基于资产的"是否上报"属性筛选 |
| 选择业务系统范围 | 下拉多选 | 业务系统列表 | 按资产组显示顺序排序，支持搜索 |

### 6.2 业务规则
- 业务系统选择：直接选择目标业务系统节点，不递归查询子节点
- 执行顺序：按业务系统在资产组管理中的"显示顺序"字段排序
- 资产查询：根据所选业务系统ID + 资产范围条件查询资产列表

---

## 7. 自动下发模式

### 7.1 通用配置

| 配置项 | 类型 | 说明 |
|--------|------|------|
| 选择工具 | 单选卡片 | 展示可用的扫描工具及版本 |
| 合规模板 | 下拉选择 | 选择扫描使用的模板（基线和弱口令需要） |

### 7.2 差异配置

| 扫描类型 | 特殊配置 |
|----------|----------|
| 基线检测 | 需要选择模板，需要"保存原始结果"选项（默认勾选） |
| 弱口令检测 | 需要选择模板，需要"保存原始结果"选项（默认勾选） |
| 系统漏洞 | 无模板选择，无原始结果选项 |
| 外部漏洞 | 无模板选择，无原始结果选项 |

### 7.3 原始结果说明
- 基线检测和弱口令检测需要保存原始结果，用于业织合规审计
- 默认勾选"保存原始结果"
- 原始结果存储在AMR任务结果中

---

## 8. 扫描记录（轮次管理）

### 8.1 功能说明
展示自动下发的执行记录，支持查看历史扫描情况和手动触发新一轮次。

### 8.2 页面元素

| 元素 | 类型 | 说明 |
|------|------|------|
| 自动扫描情况跟踪 | 按钮 | 弹出历史扫描记录弹框 |
| 下发新一轮次任务 | 按钮 | 手动触发新一轮扫描 |

---

### 8.3 自动扫描情况跟踪弹框

点击"自动扫描情况跟踪"按钮，弹出历史扫描记录弹框。

#### 8.3.1 功能定位
记录每次调度的结果，包括成功执行和跳过的情况，用于查看历史扫描情况和失败分析。

#### 8.3.2 查询条件

| 字段 | 类型 | 说明 |
|------|------|------|
| 月份 | 月份选择器 | 按月份筛选 |
| 状态 | 下拉框 | 全部/成功/失败/部分失败/已跳过 |

#### 8.3.3 列表字段

| 字段 | 说明 | 展示方式 |
|------|------|----------|
| 序号 | 行号 | 1, 2, 3... |
| 月份 | 任务版本/月份 | 2026-01 |
| 执行轮次 | 本月第几轮（递增） | 1, 2, 3... |
| 目标名称 | 本轮包含的业务系统 | "共10个业务系统"，鼠标悬停显示详情列表 |
| 失败业务系统 | 本轮扫描失败的业务系统 | "共2个"或"-"，鼠标悬停显示详情列表 |
| 执行时间 | 本轮实际执行时间 | 2026-01-20 00:00:00 |
| 状态 | 本轮执行结果 | 成功/失败/部分失败/已跳过 |
| 操作 | 查看明细 | 链接，点击弹出明细弹框 |

#### 8.3.4 状态定义

| 状态 | 条件 | 颜色 |
|------|------|------|
| 成功 | 本轮所有业务系统的任务都执行成功 | 绿色 |
| 失败 | 本轮所有业务系统的任务都执行失败 | 红色 |
| 部分失败 | 本轮部分业务系统成功，部分失败 | 橙色 |
| 已跳过 | 因上轮有未完成任务且已超时，本轮跳过 | 灰色 |

#### 8.3.5 数据示例

| 序号 | 月份 | 执行轮次 | 目标名称 | 失败业务系统 | 执行时间 | 状态 | 操作 |
|------|------|----------|----------|--------------|----------|------|------|
| 1 | 2025-10 | 1 | 共10个业务系统 | - | 2025-10-20 00:00 | 成功 | 查看明细 |
| 2 | 2025-11 | 1 | 共10个业务系统 | 共2个 | 2025-11-20 00:00 | 部分失败 | 查看明细 |
| 3 | 2025-11 | 2 | 共2个业务系统 | - | 2025-11-25 10:00 | 成功 | 查看明细 |
| 4 | 2025-12 | 1 | 共10个业务系统 | 共10个 | 2025-12-20 00:00 | 失败 | 查看明细 |
| 5 | 2026-01 | 1 | - | - | 2026-01-20 00:00 | 已跳过 | - |

**说明**：已跳过状态的轮次，目标名称、失败业务系统显示"-"，操作列无"查看明细"链接。

---

### 8.4 轮次执行明细弹框

点击"查看明细"后，展示本轮每个业务系统的执行详情。

#### 8.4.1 明细列表字段

| 字段 | 说明 |
|------|------|
| 序号 | 行号 |
| 业务系统名称 | 业务系统名称 |
| 资产数 | 本任务包含的资产数量 |
| AMR任务ID | 关联的AMR任务ID（可点击跳转到AMR任务详情） |
| 开始时间 | 任务开始执行时间 |
| 结束时间 | 任务执行完成时间 |
| 状态 | 成功/失败 |
| 失败原因 | 失败时显示原因，成功时显示"-" |

#### 8.4.2 明细数据示例

| 序号 | 业务系统名称 | 资产数 | AMR任务ID | 开始时间 | 结束时间 | 状态 | 失败原因 |
|------|--------------|--------|-----------|----------|----------|------|----------|
| 1 | 核心交易系统 | 50 | 10001 | 2025-11-20 00:05 | 2025-11-20 02:30 | 成功 | - |
| 2 | 支付系统 | 30 | 10002 | 2025-11-20 02:35 | 2025-11-20 03:15 | 失败 | 连接超时 |
| 3 | 用户中心 | 20 | 10003 | 2025-11-20 03:20 | 2025-11-20 04:00 | 成功 | - |

---

### 8.5 手动下发新一轮次

点击"下发新一轮次任务"按钮，弹出配置弹窗：

| 配置项 | 类型 | 说明 |
|--------|------|------|
| 定时开始时间 | 日期时间选择 | 选择任务下发的时间点 |
| 选择资产范围 | 复选框组 | 全部 / 上次扫描失败资产 / 本轮未扫描到的资产 |

#### 8.5.1 资产范围说明

| 选项 | 逻辑 |
|------|------|
| 全部 | 当前配置的所有业务系统下的所有资产（根据资产范围筛选条件） |
| 上次扫描失败资产 | 最近一轮次自动下发任务中，扫描结果为失败的资产 |
| 本轮未扫描到的资产 | 当前配置的全部资产 - 本轮已通过自动下发扫描过的资产（不含专题任务） |

**说明**：
- "本轮未扫描到的资产"基于**当前配置**计算，若配置变更（如新增业务系统），新增的资产也会被纳入
- 只统计自动下发的任务，不包含专题任务

#### 8.5.2 选择规则
- 选择"全部"时，其他两项置灰不可选
- "上次扫描失败资产"和"本轮未扫描到的资产"可同时勾选，取**并集**（失败的 + 未扫描的，去重）

#### 8.5.3 下发校验
- 校验定时开始时间是否在盲时范围内，若在盲时内则提示不可选择
- 校验当前是否存在未完成的自动下发任务
- 若存在未完成任务且未超过等待时间，提示用户无法创建
- 若超过等待时间，允许创建新轮次

---

## 9. 与外部系统交互

### 9.1 AMR任务管理平台
- 调用AMR对外接口创建任务
- 传递参数：业务系统、资产列表、扫描工具、模板、创建用户等
- 任务状态同步：通过AMR接口查询任务执行状态

### 9.2 工具管理平台
- 任务创建后由AMR调度到工具管理平台
- 工具管理平台有负载控制机制（资产负载数）
- 任务按顺序执行：前一个任务完成后才下发下一个任务到工具侧
- 本系统无需额外控制任务队列

---

## 10. 数据模型

### 10.1 扫描配置表（auto_scan_config）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| scan_type | varchar | 扫描类型：baseline/weak_pwd/sys_vuln/ext_vuln |
| is_enabled | tinyint | 是否开启：0-关闭，1-开启 |
| scan_day | int | 每月开始扫描日期 |
| max_asset_per_task | int | 单个任务最大资产数 |
| timeout_hours | int | 任务超时等待时间（小时） |
| create_user_id | bigint | 自动任务创建用户ID |
| asset_scope | varchar | 资产范围：all/reported/unreported |
| tool_id | bigint | 扫描工具ID |
| template_id | bigint | 模板ID |
| save_raw_result | tinyint | 是否保存原始结果 |
| blind_time_interval | int | 距盲时间隔（小时） |
| next_exec_time | datetime | 下次执行时间（动态计算） |
| last_exec_time | datetime | 上次执行时间 |
| skip_count | int | 连续跳过次数（用于告警，成功创建任务后清零） |
| create_time | datetime | 创建时间 |
| update_time | datetime | 更新时间 |

### 10.2 扫描配置-业务系统关联表（auto_scan_config_system）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| config_id | bigint | 扫描配置ID |
| system_id | bigint | 业务系统ID |
| sort_order | int | 执行顺序（从资产组显示顺序获取） |

### 10.3 盲时配置表（auto_scan_blind_time）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| config_id | bigint | 扫描配置ID |
| blind_type | varchar | 盲时类型：month/date/time_range |
| blind_value | varchar | 盲时值：月份(11)/日期(10-01)/时间段(06:00-18:00) |

### 10.4 扫描轮次表（auto_scan_round）

记录每一轮调度的整体情况。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| config_id | bigint | 扫描配置ID |
| task_version | varchar | 任务版本/月份（如：202601） |
| round_no | int | 本月轮次序号（1=本月第一轮，2=本月第二轮...） |
| trigger_type | varchar | 触发类型：auto/manual |
| status | varchar | 状态：success/failed/partial_failed/skipped |
| skip_reason | varchar | 跳过原因（status=skipped时记录，如"上轮任务未完成且已超时"） |
| total_task_count | int | 本轮任务总数（业务系统数量），skipped时为0 |
| success_task_count | int | 成功任务数，skipped时为0 |
| failed_task_count | int | 失败任务数，skipped时为0 |
| plan_start_time | datetime | 计划开始时间（手动触发时的定时时间） |
| actual_start_time | datetime | 实际开始时间 |
| end_time | datetime | 结束时间 |
| create_time | datetime | 创建时间 |
| update_time | datetime | 更新时间 |

**状态说明**：
- success：成功（所有任务执行成功）
- failed：失败（所有任务执行失败）
- partial_failed：部分失败（部分任务成功，部分失败）
- skipped：已跳过（因上轮有未完成任务且已超时）

**说明**：skipped 状态的轮次，任务明细表（auto_scan_round_task）无对应数据。

### 10.5 扫描轮次任务明细表（auto_scan_round_task）

记录每轮调度中每个任务的执行情况。

**注意**：skipped 状态的轮次无任务明细数据。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| round_id | bigint | 轮次ID（关联auto_scan_round） |
| system_id | bigint | 业务系统ID |
| system_name | varchar | 业务系统名称（冗余，便于展示） |
| exec_order | int | 执行顺序 |
| asset_count | int | 本任务资产数 |
| amr_task_id | bigint | AMR任务ID（调用AMR接口后返回） |
| amr_task_name | varchar | AMR任务名称 |
| status | varchar | 状态：pending/running/completed/failed |
| start_time | datetime | 开始时间 |
| end_time | datetime | 结束时间 |
| fail_reason | varchar | 失败原因（status=failed时记录） |
| create_time | datetime | 创建时间 |
| update_time | datetime | 更新时间 |

**任务状态说明**：
- pending：待执行（任务已创建，等待AMR调度）
- running：执行中（AMR正在执行）
- completed：已完成（执行成功）
- failed：已失败（执行失败）

**轮次状态与任务状态的关系**：
- 轮次 success = 所有任务 completed
- 轮次 failed = 所有任务 failed
- 轮次 partial_failed = 部分任务 completed，部分任务 failed
- 轮次 skipped = 无任务明细

### 10.6 表关系说明

```
auto_scan_config (配置表)
    │
    ├── auto_scan_config_system (配置-业务系统关联)
    │
    ├── auto_scan_blind_time (盲时配置)
    │
    └── auto_scan_round (轮次表)
            │
            └── auto_scan_round_task (轮次任务明细)
```

### 10.7 关键查询场景

| 场景 | 查询方式 |
|------|----------|
| 判断最近一轮是否有未完成任务 | 查询 auto_scan_round 最新一条非 skipped 状态的记录，再查其下 auto_scan_round_task 是否有 status 为 pending 或 running 的任务 |
| 获取上次扫描失败的资产 | 查询最近一轮非 skipped 状态的 auto_scan_round_task 中 status=failed 的记录，再关联资产表 |
| 获取本轮未扫描到的资产 | 当前配置的资产 - 本轮 auto_scan_round_task 中已包含的资产 |
| 连续跳过告警 | 读取 auto_scan_config.skip_count |
| 查询已跳过的轮次 | 查询 auto_scan_round 中 status=skipped 的记录 |

---

## 11. 边界场景处理

### 11.1 配置变更时的边界处理

| 场景 | 处理方式 |
|------|----------|
| 有正在执行的轮次时修改配置 | 正在执行的轮次不受影响，新配置从下一轮次生效 |
| 修改业务系统范围 | 当前轮次按原配置执行，下一轮次使用新配置 |
| 修改资产范围 | 当前轮次按原配置执行，下一轮次使用新配置 |

### 11.2 手动触发的边界处理

| 场景 | 处理方式 |
|------|----------|
| 选择"上次扫描失败资产"但无失败资产 | 提示"当前无符合条件的资产"，不允许创建空任务 |
| 选择"本轮未扫描到的资产"但资产已全部扫描 | 提示"当前无符合条件的资产"，不允许创建空任务 |
| 同时勾选两项但并集结果为空 | 提示"当前无符合条件的资产"，不允许创建空任务 |

### 11.3 业务系统/资产变更的边界处理

| 场景 | 处理方式 |
|------|----------|
| 配置中的业务系统被删除 | 调度时跳过已删除的业务系统，记录日志 |
| 业务系统下的资产全部被删除 | 调度时跳过该业务系统（无资产可扫描），记录日志 |
| 所有配置的业务系统都无效 | 本轮标记为 failed，记录失败原因"无有效业务系统" |

### 11.4 并发控制

| 场景 | 处理方式 |
|------|----------|
| 同一扫描类型，自动调度和手动触发同时发生 | 加锁控制，同一时刻只能有一个创建任务的操作 |
| 多实例部署时的并发 | 使用分布式锁（Redis或数据库锁），避免重复触发 |

### 11.5 月份边界处理

| 场景 | 处理方式 |
|------|----------|
| 配置扫描日期为31号，当月不足31天 | 取当月最后一天（如2月取28/29号，4月取30号） |
| 下次执行时间计算 | 每次都按配置的日期计算，31号配置在2月是28/29号，在3月是31号 |

**示例**：
- 配置扫描日期：31号
- 2月28日触发调度 → 下次执行时间：3月31日
- 3月31日触发调度 → 下次执行时间：4月30日

### 11.6 跨年边界处理

| 场景 | 处理方式 |
|------|----------|
| 12月调度计算下次执行时间 | 正确计算到次年1月 |
| task_version 字段格式 | YYYYMM 格式，跨年时正确递增（202612 → 202701） |
| round_no 轮次序号 | 每月重新从1开始计数，跨年不影响 |

### 11.7 AMR接口异常处理

| 场景 | 处理方式 |
|------|----------|
| 调用AMR创建任务接口失败（网络异常、超时等） | 本轮标记为 failed，记录失败原因 |
| 部分任务创建成功、部分失败 | 已创建的任务正常执行，本轮最终状态根据实际执行结果判断 |
| AMR接口返回错误 | 记录错误信息到 fail_reason 字段 |

**说明**：AMR接口调用失败时不进行自动重试，需人工排查问题后通过手动触发补充。

### 11.8 轮次号规则

| 规则 | 说明 |
|------|------|
| round_no 计数范围 | 每月独立计数，从1开始 |
| 跨月重置 | 新月份第一轮 round_no = 1 |
| 同月多轮 | 递增（1, 2, 3...） |

**示例**：
- 2026年1月第1轮：task_version=202601, round_no=1
- 2026年1月第2轮（手动触发）：task_version=202601, round_no=2
- 2026年2月第1轮：task_version=202602, round_no=1

---

## 12. 非功能需求

### 12.1 性能要求
- 下次执行时间计算：< 100ms
- 任务创建响应时间：< 3秒
- 支持单次创建100+任务
- 调度采用动态触发，无固定频率轮询开销

### 12.2 可靠性要求
- 服务重启后自动恢复调度任务
- 调度任务异常时记录日志并延迟重试
- 记录详细的执行日志便于排查

### 12.3 兼容性
- 与现有AMR任务管理平台接口兼容
- 与工具管理平台负载控制机制协同工作

### 12.4 部署要求
- 单机部署：无特殊要求
- 集群部署：需增加分布式锁（Redis或数据库锁），避免多实例重复触发

---

## 13. 附录

### 13.1 术语说明

| 术语 | 说明 |
|------|------|
| AMR | 任务管理平台，负责任务的创建、调度、状态管理 |
| 盲时 | 不允许下发扫描任务的时间段 |
| 轮次 | 一次完整的调度执行周期 |
| 工具管理 | 扫描工具管理平台，负责实际执行扫描任务 |
| 负载 | 工具管理平台同时处理的资产数量限制 |

### 13.2 参考文档
- AMR任务管理平台接口文档
- 资产组管理功能说明
- 工具管理平台负载配置说明
